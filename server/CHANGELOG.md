# 更新日志 (Changelog)


## [1.7.2] - 2025-12-05

### ⚡ Performance & Stability (性能与稳定性)

#### 1. 生产级服务器迁移 (Waitress)
- **移除 Flask 开发服务器**：不再使用 `app.run`，改用 **Waitress** WSGI 服务器启动应用。
- **高并发配置**：配置了 **32 线程** (`threads=32`) 处理并发请求，彻底解决 Android 端多图加载时的 "unexpected end of stream" 错误。
- **抗干扰优化**：
  - 连接超时 (`channel_timeout`) 延长至 **300秒**，适应弱网环境。
  - 增加输出缓冲区 (`outbuf_overflow`) 至 **20MB**，防止大图传输中断。
  - 增加连接池上限 (`connection_limit`) 至 200。

### 🚀 New Features (新增功能)

#### 2. Base64 缩略图内嵌 (Zero-Latency Sync)
- **Base64 传输策略**：API 返回的任务列表中，缩略图不再通过 URL 异步加载，而是直接以 **Base64 字符串** 形式内嵌在 JSON 数据中。
- **移动端优化**：彻底消灭了列表页的并发 HTTP 请求，实现移动端列表“秒开”且无裂图。
- **自动生成缩略图**：引入 `Pillow` 库，在图片上传时自动生成 `_thumb.jpg` 缩略图（最大 300px）。

#### 3. 全功能笔记 API (Full Note Sync)
- **新增笔记接口**：实现了笔记的增 (`POST`)、删 (`DELETE`)、改 (`PUT`) 完整 API。
- **多图上传支持**：API 支持 `multipart/form-data` 协议，允许一次性上传多张图片并自动关联任务。

### 🛠 Backend Changes (后端调整)

- **API 响应结构升级**：`/api/tasks` 返回的数据结构中，`notes` 字段下的图片信息新增 `thumb_base64` 字段。
- **依赖库更新**：
  - 新增 `waitress`：用于替代 Flask 原生服务器。
  - 新增 `Pillow`：用于图像处理和缩略图生成。

### 📦 Dependencies (依赖更新)
请务必更新 `requirements.txt` 并重建 Docker 镜像：
- `waitress`
- `Pillow`

## [1.7.1] - 2025-12-04

### 🚀 New Features (新增功能)

#### 1. 归档系统 (Archive System)
- **归档/恢复机制**：实现了任务的“归档”与“恢复”双向操作，保持主列表整洁。
- **归档箱视图**：新增独立的归档箱页面，用于查看和管理历史任务。
- **数据库自动迁移**：升级了 `check_and_migrate_db` 逻辑，支持自动检测并添加 `is_archived` 和 `archived_at` 字段，实现无损升级。

#### 2. 高级导出系统 (Export to Word)
- **Word 格式支持**：将导出格式从 Markdown 升级为 Word (`.docx`)，实现更好的兼容性。
- **图片嵌入**：笔记中的图片现在会直接嵌入 Word 文档中（不再是路径引用），实现真正的“单文件离线备份”。
- **格式优化**：导出的文档包含任务元数据、正文，并按时间轴自动排列笔记和对应图片。
- **批量打包**：支持批量选中任务，生成包含多个 `.docx` 文件的 `.zip` 压缩包一键下载。

#### 3. 批量操作模式 (Batch Operations)
- **交互升级**：主界面新增“批量”模式开关，支持复选框选择。
- **底部悬浮栏**：新增底部悬浮操作栏，实时显示选中数量。
- **全选功能**：支持一键全选/反选当前页面的任务。
- **智能操作**：
  - 在主列表：显示“批量归档”和“打包下载”。
  - 在归档箱：显示“批量删除”（带二次确认高能预警）和“打包下载”。

### 🛠 Code Refactoring (代码重构)
- **前端代码分离**：
  - 将 `dashboard.html` 中的 CSS 样式剥离至 `static/style.css`。
  - 将 JavaScript 逻辑剥离至 `static/script.js`。
  - 极大地精简了 HTML 结构，提升了代码可维护性。
- **后端逻辑优化**：
  - 引入 `python-docx` 库处理文档生成。
  - 重构 `batch_action` 路由，统一处理归档、删除、导出请求。

### 📦 Dependencies (依赖更新)
- 新增 `python-docx` 依赖（需要在 `requirements.txt` 中添加并重新构建 Docker 镜像）。



## [v1.6.0] - 2025-12-03
### ✨ 新增功能 (Features)
- **防丢机制 (Auto-Save)**: 笔记编辑框增加本地缓存功能。即使浏览器崩溃或意外刷新，再次进入详情页时也会提示恢复未提交的草稿。
- **会话保活 (Keep-Alive)**: 前端增加心跳机制，每 5 分钟向服务器发送一次信号，防止长时间挂机导致页面自动退出。

### 🛠 修复与优化 (Fixes & Improvements)
- **登录状态优化**: 设置会话有效期为 30 天 (`PERMANENT_SESSION_LIFETIME`)，解决了编辑过程中频繁自动退出的问题。
- **时间修正**: 在 Docker 容器中强制指定 `TZ=Asia/Shanghai` 时区，修复了应用内时间与 NAS 系统时间不一致的问题。
- **资源优化**: 默认关闭 Flask 调试模式 (`FLASK_DEBUG=0`)，降低闲置时的资源占用。

## [v1.5.0] - 2025-12-03
### ✨ 新增功能 (Features)
- **黑夜模式**: 支持一键切换深色/浅色主题，并自动记忆用户偏好。
- **高级搜索**: 顶部导航栏增加全局搜索，新增高级筛选面板（支持按分类、时间范围、关键词组合筛选）。
- **添加时间**: 任务卡片和详情页现在会显示任务的创建时间和完成时间。
- **时间排序**: 支持按“最新创建”或“最新完成”对任务进行排序。
- **下拉菜单**: 在分类中加入已添加的下拉菜单。
- **数据库更新**: 支持检测数据库格式，自动更新，不会对之前的数据造成损坏。

### 🛠 改进与修复 (Improvements & Fixes)
- **数据库自动迁移**: 增加启动自检逻辑，自动为旧版数据库添加 `created_at` 字段，确保数据无损升级。
- **UI 优化**: 优化了卡片视图和列表视图在移动端的显示效果。
- **Bug修复**: 修复了截止日期判断逻辑中 `now` 变量未定义导致的 500 错误。

## [v1.4.0] - 2025-12-02
- 支持任务分类下拉选择。
- 增加完成时间显示。

## [v1.3.0] - 2025-12-02
- 支持图文笔记多图上传与再次编辑。