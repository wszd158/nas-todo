# Changelog

All notable changes to the **NasTodoApp** project will be documented in this file.

## [1.1.2] - 2025-12-08 (Patch Release)

### 🎨 UI/UX 改进与修复 (UI Polish & Fixes)
* **深色模式弹窗重构 (Dark Mode Dialog Overhaul)**:
    * **自定义任务弹窗**: 弃用了 Android 系统原生的 `AlertDialog` 按钮栏，改为完全自定义的 XML 布局。彻底解决了在深色模式下，弹窗底部出现白色背景条的视觉 Bug。
    * **输入框可见性修复**: 移除了输入框和弹窗背景的硬编码颜色（原为白色），全面采用动态主题属性 (`?attr/colorSurface`, `?attr/colorOnSurface`)。
    * **效果**: 现在无论是“添加任务”还是“添加笔记”，在深色模式下均呈现完美的深灰背景与白色文字，不再出现“白底白字”无法输入的情况。
* **交互优化**:
    * 优化了输入框的样式，移除旧版灰色背景，回归符合 Material Design 规范的下划线风格。

---

## [1.1.1] - 2025-12-08 (Stable Release)

### 🚀 核心功能增强 (Core Features)
* **排序功能重构 (Sorting Fix)**:
    * 修复了离线模式下“按完成时间”、“按到期日”排序不生效的问题。
    * 实现了基于内存的实时排序逻辑，切换排序方式立即生效，无需重新请求网络。
    * 数据模型新增 `completed_at` 字段，确保排序依据准确。
* **文档导出 (DOCX)**:
    * 任务详情页新增“下载 DOCX”功能，调用系统下载管理器，支持后台下载并通知。
    * 导出格式包含大标题、元数据及笔记内容，完美复刻服务端格式。
* **笔记编辑升级**:
    * 支持在编辑笔记时**添加新图片**。
    * 支持预览已有图片并标记删除，离线状态下操作会自动暂存并同步。
* **登录体验**:
    * 新增右下角悬浮按钮 (FAB)，一键展开/填充历史登录记录。

### 🎨 UI/UX 焕新 (Visual Updates)
* **全新蓝色主题 (Material Blue)**:
    * 品牌主色调更新为清新的浅蓝色/深蓝色组合，App 图标同步更新。
* **深色模式完美适配 (Dark Mode Polish)**:
    * **顶部一体化**：Toolbar 与状态栏统一为深灰色 (`#1E1E1E`)，消除视觉割裂感。
    * **高对比度菜单**：强制弹出菜单文字为白色，解决深色背景下文字不可见的问题。
* **界面布局优化**:
    * 登录页采用绝对居中布局，增加呼吸感。
    * 更换了更高清的矢量图标（蓝色编辑、红色删除）。

### 🐛 关键修复 (Critical Fixes)
* **闪退修复**: 修复了 `addTask` 方法因缺失参数 (`notes`, `completed_at`) 导致应用崩溃的严重 Bug。
* **数据一致性**: 修复了本地 Room 数据库与服务端数据结构不匹配的问题。
* **资源加载**: 修复了部分图片 URL 路径拼接错误导致原图无法加载的问题。
* **编译修复**: 修复了 XML 资源链接失败的问题。

### ⚠️ 升级注意 (Upgrade Note)
* **强烈建议卸载重装**：由于本次更新修改了本地数据库结构 (新增 `completed_at` 字段)，直接覆盖安装可能会导致闪退。请先卸载旧版本，再安装本版本以重建数据库。

---

## [1.0.0] - 2025-12-07 (Major Release)

### 🎉 里程碑 (Milestone)
**NasTodoApp 正式发布 v1.0.0 版本！**
本次更新标志着应用架构的彻底重构。我们引入了 **“离线优先 (Offline-First)”** 架构，彻底解决了弱网或无网环境下的使用痛点，并大幅提升了 UI 质感与交互体验。

### 🚀 新增功能 (Added)
* **离线核心能力**：
    * **本地数据库 (Room)**：引入 SQLite 抽象层，实现数据的本地持久化存储，支持秒开应用，不再依赖实时网络。
    * **UUID 全局唯一标识**：客户端获得 ID 生成权，支持离线创建任务和笔记，彻底消除 ID 冲突。
    * **离线笔记暂存**：新增 `offline_notes` 机制，离线添加的笔记（含图片引用）会暂存本地，待网络恢复后自动上传。
* **智能同步引擎**：
    * **自动同步**：应用启动或刷新时，自动检测本地脏数据（Dirty Data）并推送至服务器，随后拉取最新数据。
    * **双向数据流**：完美支持“离线创建 -> 联网自动上传”的无缝体验。
* **登录增强**：
    * **历史记录 (History)**：新增登录历史功能，点击右下角悬浮按钮 (FAB) 可快速切换/填入常用的服务器地址和账号。
    * **图片预览**：在添加笔记的弹窗中，新增图片横向滚动预览区，上传前即可确认选中的图片。

### 🎨 UI/UX 改进 (Changed)
* **登录界面重构**：
    * 采用 `RelativeLayout` 实现**绝对居中**布局，视觉重心更稳。
    * 引入 **FloatingActionButton (FAB)** 作为历史记录入口，置于右下角，提升操作便捷性与设计感。
    * 优化输入框左右边距 (`marginHorizontal`)，增加呼吸感。
* **沉浸式体验**：
    * 全面适配 **Edge-to-Edge** 显示，添加 `fitsSystemWindows` 属性，完美解决状态栏遮挡内容的问题。
    * **状态栏颜色融合**：
        * **亮色模式**：紫色状态栏 + 紫色 Toolbar。
        * **暗色模式**：紫色状态栏 + 紫色 Toolbar + 黑色内容背景（保持品牌色调同时也护眼）。
        * **护眼模式**：棕色状态栏 + 棕色 Toolbar。
    * 彻底消除了“头身分离”的视觉割裂感。
* **暗色模式优化**：修复了部分控件（如 ChipGroup、Menu）在深色背景下文字不可见的问题，全面采用动态主题属性 (`?attr/colorOnSurface`)。

### 🛠 技术架构变更 (Technical)
* **数据模型升级**：
    * 将所有主键 ID 类型从 `Int` 迁移至 `String (UUID)`。
    * 数据库版本升级至 `version 2`，包含 `Task` 和 `OfflineNote` 表结构。
* **网络层优化**：
    * API 请求兼容 UUID 格式。
    * 优化了 `Retrofit/OkHttp` 的错误处理逻辑，网络失败时自动降级为本地存储操作。

### 🐛 修复 (Fixed)
* 修复了登录页在某些机型上左右无缩进的问题。
* 修复了添加笔记弹窗 XML 标签未闭合导致的编译错误。
* 修复了 `TaskDetailActivity` 和 `MainActivity` 中部分类库 (`LayoutInflater`, `MultipartBody`) 引用缺失的问题。
* 修复了退出登录时错误清空服务器地址的问题，现在仅移除密码凭证。

---
> **升级提示**: 
> 由于数据库结构发生重大变更 (Int -> UUID)，本次更新需要服务端同步升级至支持 UUID 的版本。旧版 App 建议卸载后重新安装以避免缓存冲突。

## [0.5.5] - 2025-12-06

### 🚀 新增功能 (Added)
* **多主题支持**：
    * 新增 **夜间深色模式 (Dark Mode)**。
    * 新增 **护眼模式 (Eye Care Mode)**，采用羊皮纸黄背景，减少视觉疲劳。
    * 支持在右上角菜单中动态切换主题，并持久化保存用户偏好。
* **任务详情增强**：
    * 新增 **优先级设置** (High/Normal/Low)，使用下拉菜单选择。
    * 新增 **时间管理**：支持设置任务的“开始时间”和“截止时间”，集成原生日期与时间选择器。
    * 新增 **归档功能**：支持将任务标记为已归档。
* **主页交互升级**：
    * 新增 **分类筛选栏 (ChipGroup)**：顶部动态生成分类胶囊，支持横向滚动快速筛选任务。
    * 新增 **排序功能**：支持按“创建时间”、“截止时间（最急）”和“完成时间”排序。
    * 新增 **搜索功能**：支持通过关键词实时搜索任务。
    * 新增 **查看归档**入口：可切换查看已归档的历史任务。
    * 新增 **长按删除**：在主页列表长按任务项可弹出删除确认框。
* **笔记与图片管理**：
    * 新增 **删除笔记**功能（点击笔记旁的垃圾桶图标）。
    * 新增 **编辑笔记**功能（点击铅笔图标修改文本内容）。
    * 新增 **原图保存**功能：在查看大图时，支持点击保存按钮将图片下载至手机相册 (`Pictures/NasTodo`)。

### 🛠 优化与变更 (Changed)
* **登录体验优化**：
    * 重构登录逻辑：点击登录时优先进行网络连通性验证（Verify Pre-login），失败时提示具体错误码。
    * 优化“记住我”策略：默认始终保留服务器地址和用户名，勾选框仅控制是否保存密码。
    * 安全优化：登录成功后通过内存（Intent）传递密码，解决“不记住密码”模式下 API 请求报 401 的问题。
* **架构调整**：
    * 数据传输优化：主页跳转详情页由“传递完整 JSON”改为 **“仅传递 Task ID”**，详情页自动联网拉取最新数据。这彻底解决了因图片 Base64 数据过大导致的 `TransactionTooLargeException` 崩溃及数据传输丢失问题。
    * 移除图片加载器的激进重试拦截器，以便在加载失败时暴露真实的错误原因。
* **UI/UX**：
    * 全面移除布局文件中的硬编码颜色（如 `#FFFFFF`），替换为语义化主题属性（如 `?attr/colorSurface`），完美适配多主题。
    * 使用 `NestedScrollView` 替换普通的 ScrollView，并禁用 RecyclerView 的嵌套滚动，解决了长列表显示不全（被截断）的布局 Bug。

### 🐛 修复 (Fixed)
* **后端 API**：修复了获取单条任务详情接口报 **405 Method Not Allowed** 的错误（补充了 GET 请求处理逻辑）。
* **数据持久化**：修复了退出登录或不勾选记住密码时，错误清空服务器地址和用户名的问题。
* **显示异常**：
    * 修复了黑夜模式下，分类标签 (Chips) 和弹出菜单文字颜色不可见（黑底黑字）的问题。
    * 修复了笔记列表 XML 标签未闭合导致的 `AaptCompiler` 编译错误。
    * 修复了原图加载失败的问题（修正了 URL 拼接逻辑及 Auth Header 缺失）。

---
> **Note for Developers**: 
> 此版本涉及后端 API 变动（新增时间字段及 GET 详情接口），请确保服务器端 Docker 容器已更新至最新构建版本。